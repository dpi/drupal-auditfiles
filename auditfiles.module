<?php

/**
 * Audit files carries out a simple audit of the Drupal upload directory
 * and the {files} table, to look for inconsistencies
 */


/**
 * Implementation of hook_help().
 */
function auditfiles_help($path, $arg) {
  switch ($path) {
    case 'admin/settings/auditfiles':
      return t('You can choose to exclude specific files, paths and extensions from the \'files 
        not in database\' audit report by adding them to the relevant lists below.');
    case 'admin/help#auditfiles':
      return '<p>'. t('The audit files module performs an audit of the file table and the files 
        directory to check for inconsistencies.') .'</p>';
    case 'admin/reports/auditfiles':
      $output .= '<p>'.t('The files listed below are in the files directory on the server but 
        appear to have no corresponding entry in the {files} table. Files in "temporary" folders 
        such as those created by the image module are included in order to check that they are not 
        filling up. You can choose to delete files from this report but remember that if you do 
        this the action cannot be undone. You can also add files to the {files} table - you might
        do this if you have uploaded files outside of Drupal (e.g., by ftp) and will be attaching
        them to nodes through the other tools.').'</p>';
      $output .= '<p>'.t('Files in this list are relative to the files directory %directorypath.', array('%directorypath' => file_directory_path())).'</p>';
      // If on a confirmation form then suppress the help message
      if ($_POST['operation'] && $_POST['files']) $output = '';
      return $output;
    case 'admin/reports/auditfiles/notonserver':
      $output .= '<p>'.t('The files listed below are in the {files} table but the physical files 
        do not exist on the server. This might mean the file has been deleted using a program such 
        as FTP, or it may mean there is an error in the database.</p><p>If the file was uploaded 
        using the upload module then you can click on the node number to view the item to which 
        the missing file relates to try and determine what action needs to be taken, or you can 
        click the edit link to open the node editing form directly.').'</p>';
      $output .= '<p>'.t('Files in this list are relative to the files directory %directorypath.', 
        array('%directorypath' => file_directory_path())).'</p>';
      return $output;
    case 'admin/reports/auditfiles/references':
      $output .= '<p>'.t('Listed here are file references embedded in node bodies which do
        not have exact correspondences in the {files} and {upload} tables. If there is a file
        in the {files} table with a corresponding base name, that is listed. Scenarios are:
        <ul><li><strong>No match at all in the {files} table.</strong> Go to <strong>Files
        not in database</strong> and make sure any files that exist have been added to the database.
        If they have, you should either find and upload the missing file and run this report
        again, or remove the reference from the node.</li>
        <li><strong>Multiple matches in the {files} table.</strong> This can happen when the same
        filename is in multiple directories in the uploded file hierarchy. You can review the 
        alternate files and delete any that are true duplicates. When different files have the
        same basename, you can select the one that goes with the given node and choose 
        <strong>Attach selected files</strong>. This will rewrite the reference in the node
        to use the canonical relative URL to the file, and if necessary add the reference
        to the {upload} table.</li>
        <li><strong>A single match in the {files} table.</strong> You can make the attachments
        between these nodes and the corresponding files one-by-one by selecting them and choosing
        <strong>Attach selected files</strong>, or automatically apply it to all single-match
        cases with <strong>Attach all unique matches</strong>.</li></ul>').'</p>';
      $output .= '<p>'.t('Files in this list are relative to the files directory %directorypath.', 
        array('%directorypath' => file_directory_path())).'</p>';
      return $output;
    case 'admin/reports/auditfiles/unreferenced':
      $output .= '<p>'.t('The files listed below are in the {files} table but no nodes are recorded
        as referencing them (i.e., there\'s no entry in the {upload} table). This might mean the 
        node has been deleted without deleting the file, or that the files were uploaded by some
        means other than the upload module (e.g., ftp) and the relationships between files and
        nodes have not been made. If you have used the <strong>Missing references</strong> report
        and accounted for all files that should be referenced, and are sure that the files below
        are not needed, you can delete them. Click on the basename to get a list of all nodes
        referencing that base filename (the <strong>Missing references</strong> report only
        identifies <strong>&lt;img&gt;</strong> and <strong>window.open</strong> references,
        this may help you identify if the file is referenced by another means).').'</p>';
      $output .= '<p>'.t('Files in this list are relative to the files directory %directorypath.', 
        array('%directorypath' => file_directory_path())).'</p>';
      return $output;
  }
}


/**
 * Implementation of hook_perm().
 */
function auditfiles_perm() {
  return array(
    'access file audits',
    'administer file audits',
  );
}


/**
 * Implementation of hook_menu().
 */
function auditfiles_menu() {

  $items = array();

  $items['admin/reports/auditfiles'] = array(
    'title' => t('Audit files'),
    'description' => t('List files that are not on the server or not in the database.'),
    'page callback' => 'auditfiles_notindb',
    'access arguments' => array('access file audits'),
    'file' => 'notindb.admin.inc',
  );

  $items['admin/reports/auditfiles/notindb'] = array(
    'title' => t('Not in database'),
    'description' => t('List files that are on the server but are not in the database.'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );

  $items['admin/reports/auditfiles/notonserver'] = array(
    'title' => t('Not on server'),
    'description' => t('List files that are in the database, but are not on the server.'),
    'page callback' => 'auditfiles_notonserver',
    'access arguments' => array('access file audits'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'notonserver.admin.inc',
    'weight' => -5,
  );
  
  $items['admin/reports/auditfiles/references'] = array(
    'title' => t('Missing references'),
    'description' => t('List files referenced by nodes, but not properly linked or attached.'),
    'page callback' => 'auditfiles_references',
    'access arguments' => array('access file audits'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'references.admin.inc',
    'weight' => 0,
  );
    
  $items['admin/reports/auditfiles/unreferenced'] = array(
    'title' => t('Unreferenced'),
    'description' => t('List files that are in the database, but are not referenced by any node.'),
    'page callback' => 'auditfiles_unreferenced',
    'access arguments' => array('access file audits'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'unreferenced.admin.inc',
    'weight' => 5,
    );
  
  $items['admin/reports/auditfiles/unreferenced/%'] = array(
    'title' => 'Referencing nodes',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('auditfiles_node_references_form', 4),
    'access arguments' => array('access file audits'),
    'type' => MENU_CALLBACK,
    'file' => 'unreferenced.admin.inc',
  );
  
  $items['admin/settings/auditfiles'] = array(
    'title' => 'Audit files',
    'description' => 'Set file, extension and path exclusions for file audits.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('auditfiles_admin_settings'),
    'access arguments' => array('administer file audits'),
    'file' => 'auditfiles.admin.inc',
  );

  return $items;
}


/**
 * Implementation of hook_theme()
 */
function auditfiles_theme() {
  return array(
    'auditfiles_notindb_form' => array(
      'arguments' => array('form' => NULL),
      'file' => 'notindb.admin.inc',
    ),
    'auditfiles_unreferenced_form' => array(
      'arguments' => array('form' => NULL),
      'file' => 'unreferenced.admin.inc',
    ), 
    'auditfiles_node_references_form' => array(
      'arguments' => array('form' => NULL),
      'file' => 'unreferenced.admin.inc',
    ),
    'auditfiles_references_form' => array(
      'arguments' => array('form' => NULL),
      'file' => 'references.admin.inc',
    ),
  );
}
